<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TRV — kWh TTC (Option Base, 6 kVA)</title>
  <meta name="theme-color" content="#5A52FF" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root{
      --pn:#5A52FF;     /* papernest indigo */
      --bg:#F6F7FB;
      --card:#FFFFFF;
      --text:#0E1320;
      --muted:#6B7280;
      --line:#EEF1FB;
      --grid:rgba(16,24,40,.06);
      --shadow:0 18px 44px rgba(15,20,40,.10);
      --radius:20px;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .wrap{max-width:1120px;margin:40px auto;padding:0 18px}
    .card{position:relative;background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);padding:26px 22px 16px}
    h2{margin:0 0 6px;text-align:center;font-weight:800;font-size:26px;letter-spacing:-.02em;color:var(--pn)}
    .sub{margin:0 0 8px;text-align:center;color:var(--muted);font-size:14px}
    .chart{padding:8px 6px 10px}
    canvas{width:100% !important;height:420px !important}

    /* Dernière valeur (badge) */
    .last{
      position:absolute;right:16px;top:16px;background:#fff;border:1px solid var(--line);border-radius:14px;
      padding:10px 12px;box-shadow:0 10px 24px rgba(15,20,40,.08);min-width:180px
    }
    .last h3{margin:0;font:600 12px/1 Inter;color:var(--muted)}
    .last .v{margin:4px 0 0;font:800 20px/1.2 Inter}
    .last .d{margin:2px 0 0;font:400 12px/1.2 Inter;color:var(--muted)}

    .foot{margin-top:6px;text-align:center;color:var(--muted);font-size:12px}
    a{color:var(--pn);text-decoration:none}
    a:hover{text-decoration:underline}
  </style>
</head>
<body>
  <div class="wrap">
    <section class="card">
      <div class="last" aria-live="polite">
        <h3>Dernière valeur</h3>
        <div class="v" id="lastVal">—</div>
        <div class="d" id="lastDate">—</div>
      </div>

      <h2>Prix du kWh — TRV (Option Base, 6 kVA)</h2>
      <p class="sub">PART_VARIABLE_TTC — points au <b>1ᵉʳ février</b> et <b>1ᵉʳ août</b>, depuis 2021</p>

      <div class="chart">
        <canvas id="chart" aria-label="Évolution kWh TTC (TRV Base 6 kVA)"></canvas>
      </div>

      <p class="foot">Données : <a href="Option_Base.csv">Option_Base.csv</a> • Unité : €/kWh TTC • Rendu : stepline (paliers TRV)</p>
    </section>
  </div>

  <script>
    /* ===== Helpers ===== */
    const euro = (v, d=3) => (typeof v === 'number'
      ? v.toLocaleString('fr-FR', { minimumFractionDigits: d, maximumFractionDigits: 4 })
      : v
    );
    const fmtDate = d => d.toLocaleDateString('fr-FR', { day:'2-digit', month:'short', year:'numeric' });

    function parseDate(str){
      if(!str) return new Date('');
      const s = String(str).trim();
      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); // dd/mm/yyyy
      if(m){
        const [ , dd, mm, yyyy ] = m;
        return new Date(Number(yyyy), Number(mm)-1, Number(dd));
      }
      return new Date(s); // ISO/other
    }

    function pickColumns(headers){
      const find = rxs => headers.find(h => rxs.some(rx => rx.test(h)));
      const dateCol = find([/date[_ ]?debut/i, /date.*app/i, /^date$/i, /date/i]);
      const pCol    = find([/^p[_ ]?souscrite$/i, /p[_ ]?souscrite/i]);
      const valCol  = find([/part[_ ]?variable[_ ]?ttc/i, /kwh.*ttc/i]);
      if(!dateCol) throw new Error("Colonne date introuvable (ex: DATE_DEBUT)");
      if(!pCol)    throw new Error("Colonne P_SOUSCRITE introuvable");
      if(!valCol)  throw new Error("Colonne PART_VARIABLE_TTC introuvable");
      return { dateCol, pCol, valCol };
    }

    /* ===== Data (CSV -> points Fév/Août) ===== */
    async function loadPoints(){
      const resp = await fetch('Option_Base.csv?v=' + Date.now(), { cache:'no-store' });
      if(!resp.ok) throw new Error('Option_Base.csv non trouvé à la racine du repo');
      const text = await resp.text();

      const parsed = Papa.parse(text, {
        header: true, delimiter: ";", skipEmptyLines: true, transformHeader: h => h.trim()
      });
      const rows0 = parsed.data;
      const headers = parsed.meta.fields || Object.keys(rows0[0] || {});
      const { dateCol, pCol, valCol } = pickColumns(headers);

      const rows = rows0.map(r => {
        const v = (r[valCol] ?? '').toString().trim().replace(/\s/g,'').replace(',', '.');
        const p = (r[pCol]  ?? '').toString().trim().replace(',', '.');
        const d = parseDate(r[dateCol]);
        return { date: d, p: Number(p), value: Number(v) };
      }).filter(r => r.p === 6 && Number.isFinite(r.value) && !isNaN(r.date));

      rows.sort((a,b) => a.date - b.date);

      // depuis 2021
      const start = new Date(2021, 0, 1);
      const src = rows.filter(r => r.date >= start);
      if(!src.length) return [];

      const lastDate = src[src.length - 1].date;
      const endYear = Math.max(lastDate.getFullYear(), 2025); // garantir 2025 présent
      const targets = [];
      for(let y = 2021; y <= endYear; y++){
        targets.push(new Date(y, 1, 1)); // 1 fév
        targets.push(new Date(y, 7, 1)); // 1 août
      }
      targets.sort((a,b) => a-b);

      // “merge-asof” : dernier tarif connu <= date cible
      const points = [];
      for(const t of targets){
        const prev = src.filter(r => r.date <= t).sort((a,b) => b.date - a.date)[0];
        if(prev) points.push({ date: t, value: prev.value });
      }
      return points;
    }

    /* ===== UI ===== */
    function updateLastCard(points){
      if(!points.length) return;
      const last = points[points.length-1];
      document.getElementById('lastVal').textContent  = euro(last.value, 4) + ' €/kWh';
      document.getElementById('lastDate').textContent = fmtDate(last.date);
    }

    async function boot(){
      try{
        const points = await loadPoints();
        if(!points.length) throw new Error('Aucun point trouvé (vérifie P_SOUSCRITE=6 et PART_VARIABLE_TTC)');

        updateLastCard(points);

        const labels = points.map(p => p.date.toISOString().slice(0,10));
        const data   = points.map(p => p.value);

        const ctx = document.getElementById('chart').getContext('2d');

        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'kWh TTC — 6 kVA',
              data,
              stepped: true,              // paliers TRV
              borderColor: '#5A52FF',
              borderWidth: 3,
              pointRadius: 3,             // petits points visibles
              pointHoverRadius: 6,
              pointBackgroundColor: '#5A52FF',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              fill: false                  // on reste minimal/solide (pas de gradient fragile)
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { left: 6, right: 6 } },
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#101828',
                titleColor: '#fff',
                bodyColor: '#fff',
                padding: 10,
                callbacks: {
                  title: (items) => {
                    const d = new Date(items[0].label);
                    return fmtDate(d);
                  },
                  label: (ctx) => euro(ctx.parsed.y, 4) + ' €/kWh'
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(16,24,40,.06)' },
                ticks: { color: '#586174', maxRotation: 0, autoSkip: true }
              },
              y: {
                beginAtZero: false,
                grid: { color: 'rgba(16,24,40,.06)' },
                ticks: {
                  color: '#586174',
                  callback: (v) => euro(typeof v === 'number' ? v : Number(v), 3) + ' €'
                }
              }
            }
          }
        });
      }catch(err){
        console.error(err);
        alert('Erreur: ' + err.message);
      }
    }

    boot();
  </script>
</body>
</html>
