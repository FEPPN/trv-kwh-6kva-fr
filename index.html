<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Évolution du prix du kWh (TRV, Base 6 kVA)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    /* —— Palette papernest —— */
    :root{
      --pn:#5A52FF;
      --text:#0E1320;
      --muted:#6B7280;
      --grid:rgba(16,24,40,.08);
    }

    /* —— Fond 100% transparent pour l’intégration WordPress —— */
    html, body { background: transparent !important; margin: 0; color: var(--text); }
    /* Conteneur fluide et sobre */
    .wrap{ max-width: 1080px; margin: 0 auto; padding: 0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }

    /* En-tête : titre + badge “prix en vigueur” */
    .head{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; margin: 0 0 8px; }
    h2{ margin:0; font-size:22px; font-weight:800; letter-spacing:-.02em; color:var(--pn); }
    .sub{ margin:4px 0 0; color:var(--muted); font-size:14px; font-weight:500; }

    .badge{
      display:flex; flex-direction:column; align-items:flex-end; gap:4px;
      min-width: 180px; padding:8px 12px; border-radius:12px;
      border:1px solid rgba(16,24,40,.08);
      background: rgba(255,255,255,.85); /* laisse transparaître si fond sombre */
      backdrop-filter: blur(2px);
    }
    .badge h3{ margin:0; font:600 12px/1 Inter; color:var(--muted); }
    .badge .val{ margin:2px 0 0; font:800 20px/1 Inter; color:var(--text); }
    .badge .date{ margin:0; font:400 12px/1.2 Inter; color:var(--muted); }

    /* Zone du graphique : toujours entièrement visible, pas de clipping */
    .chart{ width:100%; height: 400px; overflow: visible; }
    canvas{ display:block; width:100% !important; height:100% !important; background: transparent !important; }

    /* Sur mobile, le badge passe sous le titre pour éviter tout chevauchement */
    @media (max-width: 600px){
      .badge{ align-items:flex-start; width:100%; }
    }
  </style>
</head>
<body>
  <div class="wrap" role="region" aria-label="Évolution du prix du kWh au TRV">
    <div class="head">
      <div>
        <h2>Évolution du prix du kWh au tarif réglementé</h2>
        <p class="sub">Option Base 6&nbsp;kVA — prix TTC — paliers appliqués au 1ᵉʳ&nbsp;février et au 1ᵉʳ&nbsp;août (depuis 2021)</p>
      </div>
      <div class="badge" aria-live="polite">
        <h3>Prix en vigueur</h3>
        <div class="val" id="lastVal">—</div>
        <div class="date" id="lastDate">—</div>
      </div>
    </div>

    <div class="chart">
      <canvas id="chart" aria-label="Courbe en paliers du kWh TTC (TRV Base 6 kVA)"></canvas>
    </div>
  </div>

  <script>
    // —— Utils formatage —— //
    const euro = (v, d=3) => (typeof v==='number'
      ? v.toLocaleString('fr-FR', { minimumFractionDigits: d, maximumFractionDigits: 4 })
      : v);
    const fmtDate = d => d.toLocaleDateString('fr-FR', { day:'2-digit', month:'short', year:'numeric' });

    function parseDate(str){
      if(!str) return new Date('');
      const s = String(str).trim();
      const m = s.match(/^(\d{2})\/(\d{2})\/(\d{4})$/); // dd/mm/yyyy
      if(m){
        const [ , dd, mm, yyyy ] = m;
        return new Date(Number(yyyy), Number(mm)-1, Number(dd));
      }
      return new Date(s); // ISO/other
    }

    function pickColumns(headers){
      const find = rxs => headers.find(h => rxs.some(rx => rx.test(h)));
      const dateCol = find([/date[_ ]?debut/i, /date.*app/i, /^date$/i, /date/i]);
      const pCol    = find([/^p[_ ]?souscrite$/i, /p[_ ]?souscrite/i]);
      const valCol  = find([/part[_ ]?variable[_ ]?ttc/i, /kwh.*ttc/i]); // fallback si l'intitulé diffère
      if(!dateCol) throw new Error("Colonne date introuvable (ex: DATE_DEBUT)");
      if(!pCol)    throw new Error("Colonne P_SOUSCRITE introuvable");
      if(!valCol)  throw new Error("Colonne PART_VARIABLE_TTC introuvable");
      return { dateCol, pCol, valCol };
    }

    // Dégradé sûr (Chart.js peut appeler avant que chartArea existe)
    function makeGradient(ctx){
      const { chart } = ctx;
      const { ctx: c, chartArea } = chart;
      if (!chartArea) return 'rgba(90,82,255,0.08)'; // fallback 1er rendu
      const g = c.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
      g.addColorStop(0, 'rgba(90,82,255,0.20)');
      g.addColorStop(1, 'rgba(90,82,255,0.03)');
      return g;
    }

    async function loadPoints(){
      // Bypass cache GitHub Pages
      const resp = await fetch('Option_Base.csv?v=' + Date.now(), { cache:'no-store' });
      if(!resp.ok) throw new Error('Option_Base.csv non trouvé à la racine du repo');
      const text = await resp.text();

      const parsed = Papa.parse(text, {
        header: true, delimiter: ";", skipEmptyLines: true, transformHeader: h => h.trim()
      });
      const rows0 = parsed.data;
      const headers = parsed.meta.fields || Object.keys(rows0[0] || {});
      const { dateCol, pCol, valCol } = pickColumns(headers);

      const rows = rows0.map(r=>{
        const v = (r[valCol] ?? '').toString().trim().replace(/\s/g,'').replace(',', '.');
        const p = (r[pCol]  ?? '').toString().trim().replace(',', '.');
        const d = parseDate(r[dateCol]);
        return { date:d, p:Number(p), value:Number(v) };
      }).filter(r => r.p === 6 && Number.isFinite(r.value) && !isNaN(r.date));

      rows.sort((a,b)=>a.date-b.date);

      // Depuis 2021, et garantir 2025 visible
      const start = new Date(2021,0,1);
      const src = rows.filter(r=>r.date>=start);
      if(!src.length) return [];

      const lastDate = src[src.length-1].date;
      const endYear = Math.max(lastDate.getFullYear(), 2025);

      // Cibles : 1er février & 1er août pour chaque année
      const targets=[];
      for(let y=2021; y<=endYear; y++){
        targets.push(new Date(y,1,1)); // 1 fév
        targets.push(new Date(y,7,1)); // 1 août
      }
      targets.sort((a,b)=>a-b);

      // Valeur = dernier palier <= date cible
      const points=[];
      for(const t of targets){
        const prev = src.filter(r=>r.date<=t).sort((a,b)=>b.date-a.date)[0];
        if(prev) points.push({ date:t, value:prev.value });
      }
      return points;
    }

    function updateBadge(points){
      if(!points.length) return;
      const last = points[points.length-1];
      document.getElementById('lastVal').textContent  = euro(last.value, 4) + ' €/kWh';
      document.getElementById('lastDate').textContent = fmtDate(last.date);
    }

    async function boot(){
      try{
        const points = await loadPoints();
        if(!points.length) throw new Error('Aucun point trouvé (vérifie P_SOUSCRITE=6 et PART_VARIABLE_TTC)');

        updateBadge(points);

        const labels = points.map(p => p.date.toISOString().slice(0,10));
        const data   = points.map(p => p.value);

        const ctx = document.getElementById('chart').getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [{
              label: 'kWh TTC — Base 6 kVA',
              data,
              stepped: true,              // paliers TRV = stepline
              borderColor: '#5A52FF',
              borderWidth: 3,
              pointRadius: 3,
              pointHoverRadius: 6,
              pointBackgroundColor: '#5A52FF',
              pointBorderColor: '#fff',
              pointBorderWidth: 2,
              fill: true,
              backgroundColor: (ctx) => makeGradient(ctx),
              clip: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: { top: 8, right: 8, bottom: 8, left: 8 } },
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#101828',
                titleColor: '#fff',
                bodyColor: '#fff',
                padding: 10,
                callbacks: {
                  title: (items) => {
                    const d = new Date(items[0].label);
                    return fmtDate(d);
                  },
                  label: (ctx) => euro(ctx.parsed.y, 4) + ' €/kWh'
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(16,24,40,.06)' },
                ticks: { color: '#586174', maxRotation: 0, autoSkip: true }
              },
              y: {
                beginAtZero: false,
                grid: { color: 'rgba(16,24,40,.06)' },
                ticks: {
                  color: '#586174',
                  callback: (v) => euro(typeof v === 'number' ? v : Number(v), 3) + ' €'
                }
              }
            }
          }
        });
      }catch(err){
        console.error(err);
        alert('Erreur: ' + err.message);
      }
    }

    boot();
  </script>
</body>
</html>
